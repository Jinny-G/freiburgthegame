<!DOCTYPE html>
<html>
<head>

  <meta charset="utf-8">
  <title>Freiburg Karte mit Punkten & Firebase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }
    #colorPicker, #adminToggle, #scoreboard {
      position: absolute;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      font-family: sans-serif;
      z-index: 1000;
    }


    #colorPicker { top: 10px; left: 70px; }
    #scoreboard {
      top: 10px;
      right: 10px;
      position: fixed;
    }
    #scoreboard table {
      border-collapse: collapse;
      width: 100%;
    }
    #scoreboard th, #scoreboard td {
      border: 1px solid #ddd;
      padding: 4px 8px;
      text-align: center;
    }
   #scoreboard th {
  background-color: transparent;
}
    .adminOnly {
  display: none;
}
.adminVisible .adminOnly {
  display: block;
}

    @media (max-width: 600px) {
  #scoreboard {
    width: auto;
    font-size: 0.8em;
    top: 10px;
    right: 10px;
  }

  #scoreboard table {
    font-size: 0.85em;
  }

  #countdown {
    top: 50px;
    left: 10px;
    right: auto;
    font-size: 0.85em;
  }

  #colorPicker {
    top: auto;
    bottom: 80px;
    left: 10px;
    right: auto;
    width: 85vw;
    font-size: 0.9em;
  }

}

#countdown {
  position: fixed;
  top: 10px;
  left: 10px;
  background: white;
  padding: 4px 8px;
  font-family: sans-serif;
  font-size: 0.9em;
  border-radius: 5px;
  box-shadow: 0 0 4px rgba(0,0,0,0.25);
  z-index: 1100; /* √ºber dem Zoom-Button */
}



    .leaflet-control-zoom {
  display: none !important;
}
    .leaflet-control-scale {
  bottom: 80px !important; /* Standard ist 5px ‚Äì erh√∂he f√ºr "h√∂her" */
}
    #colorPicker {
  z-index: 1100; /* h√∂her als 1000 vom scoreboard */
}

    .teamDot {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  display: inline-block;
  margin: auto;
}

#scoreboard {
  top: 10px;
  right: 10px;
  position: fixed;
  background: white;
  border-radius: 5px;
  font-family: sans-serif;
  box-shadow: 0 0 5px rgba(0,0,0,0.3);
  z-index: 1000;
  padding: 5px;
}

#scoreboard table {
  border-collapse: collapse;
  font-size: 0.9em;
}

#scoreboard th,
#scoreboard td {
  padding: 4px 6px;
  text-align: center;
}

.chest {
  width: 140px;
  height: 105px;
  position: relative;
  margin: auto;
  transform-style: preserve-3d;
}

.lid {
  width: 100%;
  height: 52px;
  background: saddlebrown;
  border: 4px solid #5a2d0c;
  border-bottom: none;
  border-radius: 14px 14px 0 0;
  position: absolute;
  top: 0;
  left: 0;
  transform-origin: bottom center;
  transition: transform 0.6s ease-out;
  z-index: 2;
  transform-style: preserve-3d;
  transform: translateZ(1px);
}


.base {
  width: 100%;
  height: 53px;
  background: peru;
  border: 4px solid #5a2d0c;
  border-top: none;
  border-radius: 0 0 14px 14px;
  position: absolute;
  bottom: 0;
  left: 0;
  z-index: 1;
}


.open .lid {
  transform: rotateX(120deg);
}

    /* Gr√∂√üere Truhe */
#boxWrapper {
  display: inline-block;
  perspective: 800px;
  transform: scale(1.75);
  transform-origin: center;
}

/* Bronze-Truhe */
.chest.bronze .lid {
  background: linear-gradient(to bottom, #a0522d, #5a2d0c);
}
.chest.bronze .base {
  background: linear-gradient(to top, #cd7f32, #8b4513);
}

/* Silber-Truhe */
.chest.silber .lid {
  background: linear-gradient(to bottom, #dcdcdc, #a9a9a9);
}
.chest.silber .base {
  background: linear-gradient(to top, #c0c0c0, #808080);
}

/* Gold-Truhe */
.chest.gold .lid {
  background: linear-gradient(to bottom, #ffd700, #b8860b);
}
.chest.gold .base {
  background: linear-gradient(to top, #ffec8b, #daa520);
}

/* Leichter metallischer Glanz (f√ºr alle Truhen) */
.chest::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(45deg, rgba(255,255,255,0.2), rgba(255,255,255,0));
  border-radius: 10px;
  pointer-events: none;
  z-index: 5;
}


@keyframes shake {
  0% { transform: rotate(0deg); }
  20% { transform: rotate(1deg); }
  40% { transform: rotate(-1deg); }
  60% { transform: rotate(1deg); }
  80% { transform: rotate(-1deg); }
  100% { transform: rotate(0deg); }
}

.shake {
  animation: shake 0.5s infinite;
}

    .treasure-icon {
  font-size: 20px;
  opacity: 0.6;
  pointer-events: none;
  text-align: center;
  filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.4));
}


    
  </style>
</head>
<body>
  <svg style="position:absolute; width:0; height:0;">
  <defs>
    <pattern id="tripleStripes" patternUnits="userSpaceOnUse" width="12" height="12" patternTransform="rotate(45)">
      <rect x="0" y="0" width="4" height="12" fill="#fb8072" />
      <rect x="4" y="0" width="4" height="12" fill="#ffffb3" />
      <rect x="8" y="0" width="4" height="12" fill="#a6cee3" />
    </pattern>
  </defs>
</svg>

  <div id="colorPicker" class="adminOnly">
    <label for="colorSelect">Farbe w√§hlen:</label>
    <select id="colorSelect">
      <option value="#e41a1c">Rot</option>
      <option value="#fb8072">Hellrot</option>
      <option value="#377eb8">Blau</option>
      <option value="#a6cee3">Hellblau</option>
      <option value="#ffdf00">Gelb</option>
      <option value="#ffffb3">Hellgelb</option>
      <option value="#bdbdbd">Grau</option>
    </select>
  </div>

<div id="countdown">
  ‚è≥ <span id="timer">--:--</span>
</div>

<div id="adminToggle" style="
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1000;
  cursor: pointer;
  font-size: 24px;
  background: white;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  box-shadow: 0 0 5px rgba(0,0,0,0.3);
  display: flex;
  align-items: center;
  justify-content: center;
">
  <span id="lockIcon">üîí</span>
</div>

  <div id="lootboxToggle" style="
  position: fixed;
  bottom: 20px;
  right: 90px;
  z-index: 1000;
  cursor: pointer;
  font-size: 24px;
  background: white;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  box-shadow: 0 0 5px rgba(0,0,0,0.3);
  display: flex;
  align-items: center;
  justify-content: center;
">
  <span id="lootboxIcon">üéÅ</span>
</div>
  
<div id="scoreboard">
  <table>
    <thead>
      <tr>
        <th>üë•</th>
        <th>üéØ</th>
        <th>üîí</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><div class="teamDot" style="background:#e41a1c;"></div></td>
        <td id="pointsA">0</td>
        <td id="securedA">0</td>
      </tr>
      <tr>
        <td><div class="teamDot" style="background:#377eb8;"></div></td>
        <td id="pointsB">0</td>
        <td id="securedB">0</td>
      </tr>
      <tr>
        <td><div class="teamDot" style="background:#ffdf00;"></div></td>
        <td id="pointsC">0</td>
        <td id="securedC">0</td>
      </tr>
    </tbody>
  </table>
  <div id="currentCodeDisplay" style="margin-top: 6px; font-size: 0.85em; color: #444;">
  Spielcode: <strong>‚Äì</strong>
</div>
</div>

  <div id="map"></div>

  <!-- Firebase & Leaflet -->
<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

 <script type="module">
  let gameCode = localStorage.getItem("gameCode");
  let gamePassword = localStorage.getItem("gamePassword");

  async function askForGameCode() {
    if (!gamePassword) {
      const pw = prompt("üîê Bitte Master-Passwort eingeben, um einen Spielcode zu erstellen:");
      if (pw !== "i<3freiburg") {
        alert("üö´ Falsches Passwort. Zugriff verweigert.");
        return;
      } else {
        localStorage.setItem("gamePassword", pw);
        gamePassword = pw;
      }
    }

    if (!gameCode) {
      gameCode = prompt("üî¢ Gib deinen Spielcode ein oder erstelle einen neuen:");
      if (!gameCode || gameCode.trim() === "") {
        gameCode = "standard";
      }
      gameCode = gameCode.trim();
      localStorage.setItem("gameCode", gameCode);
      alert(`‚úÖ Spielcode "${gameCode}" gespeichert.`);

      // Neue Spielrunde: Initialisiere alle Gebiete mit Grau
      const allNames = [
        "Altstadt", "Betzenhausen", "St√ºhlinger", "Haslach", "Weingarten",
        "Landwasser", "Mooswald", "Neuburg", "Herdern", "Z√§hringen",
        "Waldsee", "Ebnet", "Littenweiler", "Oberau", "Wiehre",
        "Vauban", "Rieselfeld", "Hochdorf", "Mundenhof", "Tiengen",
        "Munzingen", "St. Georges", "G√ºnterstal", "Lehen", "Kappel",
        "Waltershofen", "Opfingen", "Br√ºhl"
      ];
      for (const name of allNames) {
        await db.collection(gameCode).doc(name).set({ farbe: "#bdbdbd" });
      }
       location.reload();
    }
  }

  await askForGameCode();
  

   document.getElementById("currentCodeDisplay").innerHTML =
  `Spielcode: <strong>${gameCode}</strong>`;


  // ‚¨áÔ∏è Ab hier dein ganzer restlicher Code ‚Äì Leaflet, Firebase, updateScoreboard(), alles!

    // ‚¨áÔ∏è DEIN Firebase-Konfigurationsblock hier einf√ºgen:
    const firebaseConfig = {
  apiKey: "AIzaSyCRcsMUKzIG0m1ItnMV2O1mCt4O9Br2_GY",
  authDomain: "freiburgthegame.firebaseapp.com",
  projectId: "freiburgthegame",
  storageBucket: "freiburgthegame.firebasestorage.app",
  messagingSenderId: "107696847131",
  appId: "1:107696847131:web:799f0ca624d71b2a9dbbbe"
    };

    // Firebase initialisieren
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const map = L.map('map', {
  minZoom: 11,
  maxZoom: 18
}).setView([47.988, 7.85], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    L.control.scale({ position: 'bottomleft', imperial: false }).addTo(map);
    map.on("zoomend", updateTreasureVisibility);

  // üó∫Ô∏è Schatzorte mit pr√§zisen Koordinaten
const treasureSpots = [
  { name: "Altstadt", coords: [47.995548248291016, 7.8531999588012695] },
  { name: "Betzenhausen", coords: [48.01245880126953, 7.813791275024414] },
  { name: "St√ºhlinger", coords: [47.99646947182226, 7.838819150739069] },
  { name: "Haslach", coords: [47.99039242058599,7.823738003966749] },
  { name: "Weingarten", coords: [48.006499922737014,7.804347848974311] },
  { name: "Landwasser", coords: [48.02811542612249, 7.80696873379676] },
  { name: "Mooswald", coords: [48.013505996719296, 7.823352681209208] },
  { name: "Neuburg", coords: [47.9985884198818,7.859208780255611] },
  { name: "Herdern", coords: [48.0101034491257, 7.85749627329825] },
  { name: "Z√§hringen", coords: [48.01879548543632, 7.867117293352051] },
  { name: "Waldsee", coords: [47.98291519443326, 7.876265114810983] },
  { name: "Ebnet", coords: [47.98748100863134,7.903707166707328] },
  { name: "Littenweiler", coords: [47.98132721761629, 7.894480075731445] },
  { name: "Oberau", coords: [47.99173131393934,7.8584257229733145] },
  { name: "Wiehre", coords: [47.984827888053914, 7.853200967459961] },
  { name: "Vauban", coords: [47.97259234150428,7.831802296502817] },
  { name: "Rieselfeld", coords: [48.000325753018, 7.79188686901259] },
  { name: "Hochdorf", coords: [48.038001580879815, 7.796690798469461] },
  { name: "Mundenhof", coords: [48.0114474200718,7.77996732816677] },
  { name: "Tiengen", coords: [47.986525385031705, 7.696442390579468] },
  { name: "Munzingen", coords: [47.97037260988398, 7.698656526628573] },
  { name: "St. Georges", coords: [47.97940920060929,7.807051584482672] },
  { name: "G√ºnterstal", coords: [47.971156768159354,7.845105022862722] },
  { name: "Lehen", coords: [48.017059224014965, 7.797066417311811] },
  { name: "Kappel", coords: [47.974143359784385, 7.909831391771962] },
  { name: "Waltershofen", coords: [48.0217394368563, 7.720574992172371] },
  { name: "Opfingen", coords: [47.99999151975894, 7.750699364169189] },
  { name: "Br√ºhl",coords: [48.014561316203526,7.836964348464099] }
];

// ü™ô Layer f√ºr die Schatzanzeige
const treasureLayer = L.layerGroup().addTo(map);

// Kleine Zufallsverschiebung (damit nicht zentriert)
function randomOffset() {
  return (Math.random() - 0.5) * 0.0007; // ca. ¬±10 m
}

const treasureCircles = {}; // Name ‚Üí Leaflet-Circle



    let selectedLayer = null;
    let editEnabled = false;
    let geojson = null;
    
document.getElementById("adminToggle").addEventListener("click", function () {
  if (!editEnabled) {
    const pw = prompt("Bitte Admin-Passwort eingeben:");
    if (pw === "freiburg123") {
      editEnabled = true;
      document.body.classList.add("adminVisible");
      document.getElementById("lockIcon").textContent = "üîì";
      alert("Bearbeitungsmodus aktiviert.");
    } else {
      alert("Falsches Passwort!");
    }
  } else {
    editEnabled = false;
    document.body.classList.remove("adminVisible");
    document.getElementById("lockIcon").textContent = "üîí";
    alert("Bearbeitungsmodus deaktiviert.");
  }
});

    document.getElementById("lootboxToggle").addEventListener("click", function () {
  const pw = prompt("Bitte Passwort f√ºr Lootbox eingeben:");
  if (pw === "lootbox987") {
    openLootboxPopup();
  } else {
    alert("Falsches Passwort!");
  }
});


    document.getElementById('colorSelect').addEventListener('change', function () {
      if (selectedLayer && editEnabled) {
        const selectedColor = this.value;
        selectedLayer.setStyle({ fillColor: selectedColor });
        selectedLayer.defaultColor = selectedColor;
        saveColor(selectedLayer.feature.properties.name, selectedColor);
        updateScoreboard();
        updateTreasureVisibility(); 
      }
    });

    function saveColor(id, color) {
      db.collection(gameCode).doc(id).set({ farbe: color });
    }

    async function loadColors() {
      const snapshot = await db.collection(gameCode).get();
      const farben = {};
      snapshot.forEach(doc => {
        farben[doc.id] = doc.data().farbe;
      });
      return farben;
    }

function updateScoreboard() {
  let pointsA = 0, securedA = 0;
  let pointsB = 0, securedB = 0;
  let pointsC = 0, securedC = 0;

  geojson.eachLayer(layer => {
    const color = layer.options.fillColor;
    // üí∞ Schatz sichtbar machen, wenn Gebiet nicht grau ist
if (color !== '#bdbdbd') {
  const name = layer.feature.properties.name;
  const spot = treasureSpots.find(s => s.name.startsWith(name));
  if (spot && !treasureCircles[name]) {
    const offsetLat = spot.coords[0] + (Math.random() - 0.5) * 0.001;
    const offsetLng = spot.coords[1] + (Math.random() - 0.5) * 0.001;
   const circle = L.circle([offsetLat, offsetLng], {
  radius: 200,
  color: "gold",
  fillOpacity: 0,
  weight: 4
});
circle.bindPopup(`üèô ${spot.name}`);
circle.addTo(treasureLayer);

// üí∞ Symbolmarker leicht oberhalb des Schatzkreises
const icon = L.divIcon({
  className: 'treasure-icon',
  html: 'üí∞',
  iconSize: [24, 24],
  iconAnchor: [12, 30] // leicht √ºber dem Kreis
});
const iconMarker = L.marker([offsetLat, offsetLng], { icon })
.addTo(treasureLayer);

    iconMarker.bindTooltip(spot.name, {
  permanent: false,
  direction: 'top',
  offset: [0, -10],
  opacity: 0.85
});
  // ‚¨áÔ∏è Tooltip bei Tap kurz anzeigen
  iconMarker.on('click', () => {
    iconMarker.openTooltip();
    setTimeout(() => iconMarker.closeTooltip(), 3000);
  });

treasureCircles[name] = { circle, iconMarker };


  }
}
    switch (color) {
      case '#e41a1c': pointsA++; securedA++; break;
      case '#fb8072': pointsA++; break;
      case '#377eb8': pointsB++; securedB++; break;
      case '#a6cee3': pointsB++; break;
      case '#ffdf00': pointsC++; securedC++; break;
      case '#ffffb3': pointsC++; break;
    }
  });

  document.getElementById("pointsA").textContent = pointsA;
  document.getElementById("securedA").textContent = securedA;
  document.getElementById("pointsB").textContent = pointsB;
  document.getElementById("securedB").textContent = securedB;
  document.getElementById("pointsC").textContent = pointsC;
  document.getElementById("securedC").textContent = securedC;
} // ‚úÖ HIER war bei dir die schlie√üende Klammer vergessen

function startCountdown(targetTime) {
  function update() {
    const now = new Date();
    const diff = targetTime - now;
    if (diff <= 0) {
      document.getElementById("timer").textContent = "00:00";
      return;
    }  
    const minutes = String(Math.floor(diff / 60000)).padStart(2, "0");
    const seconds = String(Math.floor((diff % 60000) / 1000)).padStart(2, "0");
    document.getElementById("timer").textContent = `${minutes}:${seconds}`;
    setTimeout(update, 1000);
  }
  update();
}

function resetAllColors() {
  if (!editEnabled) {
    alert("Nur im Admin-Modus verf√ºgbar!");
    return;
  }

  if (confirm("M√∂chtest du wirklich alle Farben zur√ºcksetzen?")) {
    geojson.eachLayer(layer => {
      layer.setStyle({ fillColor: '#bdbdbd' });
      layer.defaultColor = '#bdbdbd';
      saveColor(layer.feature.properties.name, '#bdbdbd');
    });
  treasureLayer.clearLayers();
Object.values(treasureCircles).forEach(obj => {
  if (obj.iconMarker) map.removeLayer(obj.iconMarker);
});
Object.keys(treasureCircles).forEach(k => delete treasureCircles[k]);

    updateScoreboard();
  }
} // ‚úÖ HIER war bei dir die Klammer **vergessen**!

   function resetGameCode() {
  if (!confirm("‚ö†Ô∏è Willst du wirklich ein neues Spiel starten?\nDer aktuelle Spielcode und das Admin-Passwort werden gel√∂scht.")) {
    return;
  }
  localStorage.removeItem("gameCode");
  localStorage.removeItem("gamePassword");
  location.reload();
}

// Countdown starten
const ziel = new Date();
ziel.setHours(15, 0, 0, 0);
startCountdown(ziel);



    
    function onEachFeature(feature, layer) {
      const id = feature.properties.name;

      layer.on('click', function () {
        if (!editEnabled) return;
        geojson.eachLayer(l => l.setStyle({ weight: 2 }));
        selectedLayer = layer;
        layer.setStyle({ weight: 5 });
        document.getElementById('colorSelect').value = layer.defaultColor;
      });

      const center = layer.getBounds().getCenter();
      const label = L.marker(center, {
        icon: L.divIcon({
          className: 'label',
          html: `<strong>${id}</strong>`,
          iconSize: [100, 20]
        })
      });
      label.addTo(map);
    }

  function styleFeature(color, id) {
  const fill = (id === "Altstadt" && color === "#bdbdbd") ? "url(#tripleStripes)" : color || '#bdbdbd';
  return {
    fillColor: fill,
    weight: 2,
    opacity: 1,
    color: 'black',
    fillOpacity: 0.6
  };
}


    fetch('https://raw.githubusercontent.com/codeforgermany/click_that_hood/main/public/data/freiburg.geojson')
      .then(res => res.json())
      .then(async data => {
        const farben = await loadColors();
        geojson = L.geoJSON(data, {
        style: feature => {
  const id = feature.properties.name;
  const farbe = farben[id];
  return styleFeature(farbe, id); // ‚Üê jetzt wird die id mit √ºbergeben
},

          onEachFeature: function (feature, layer) {
            const id = feature.properties.name;
            const farbe = farben[id] || '#bdbdbd';
      
            layer.defaultColor = farbe;
            onEachFeature(feature, layer);
          }
        }).addTo(map);
        updateScoreboard();
        updateTreasureVisibility();  
      });

function openLootboxPopup() {
document.getElementById("lootboxContent").innerHTML = `
  <h3>W√§hle eine Truhe:</h3>
  <div style="display: flex; justify-content: space-around; margin-top: 10px;">
    <div onclick="selectLootbox('bronze')" class="lootbox-card bronze">
      <div class="loot-price">30 FR‚Ç¨</div>
      <div class="loot-icon">üì¶</div>
      <div class="loot-label">Bronze</div>
    </div>
    <div onclick="selectLootbox('silber')" class="lootbox-card silber">
      <div class="loot-price">70 FR‚Ç¨</div>
      <div class="loot-icon">üß∞</div>
      <div class="loot-label">Silber</div>
    </div>
    <div onclick="selectLootbox('gold')" class="lootbox-card gold">
      <div class="loot-price">150 FR‚Ç¨</div>
      <div class="loot-icon">üí∞</div>
      <div class="loot-label">Gold</div>
    </div>
  </div>
`;

  document.getElementById("lootboxPopup").style.display = "block";
}

function closeLootboxPopup() {
  document.getElementById("lootboxPopup").style.display = "none";
}

// ‚≠ê Listen der Effekte pro Seltenheit
const effects = {
gew√∂hnlich: [
  {
    name: "Mini-Zeitsplitter",
    type: "Power-Up",
    desc: "Verl√§ngert die Aufgabe um 2 Minuten.",
    short: "2 Minuten zus√§tzlich zur Zeit.",
    rule: "Nur bei aktiver Aufgabe einsetzbar."
  },
  {
    name: "Kurzsicht",
    type: "Power-Up",
    desc: "20 Sek. Vorschau auf die n√§chste Aufgabe.",
    short: "Die Aufgabe wird dadurch nicht aktiv.",
    rule: "Nur einmal pro Spiel erlaubt."
  },
  {
    name: "Energieriegel",
    type: "Power-Up",
    desc: "1 Min. Pause, z√§hlt nicht zur Aufgabenzeit.",
    short: "1 Minute Durchatmen ohne Zeitverlust.",
    rule: "Pause muss durch Video belegt sein."
  },
  {
    name: "Kompass-Boost",
    type: "Power-Up",
    desc: "Himmelsrichtungshinweis erlaubt.",
    short: "Spielleitung nennt eine Himmelsrichtung.",
    rule: "Nur auf Nachfrage direkt nach dem Ziehen."
  },
  {
    name: "Wasserflasche",
    type: "Power-Up",
    desc: "1 Person darf 3 Min. voraus.",
    short: "1 L√§ufer darf 3 Min. vorgehen.",
    rule: "Nur auf offener Strecke erlaubt."
  },
  {
    name: "Flurfunk",
    type: "Power-Up",
    desc: "Stellt einem Team eine ehrliche Frage.",
    short: "1 ehrliche Info von anderem Team.",
    rule: "Frage muss klar, direkt und eindeutig sein."
  },
  {
    name: "Pfadfinderblick",
    type: "Power-Up",
    desc: "1 Ja/Nein-Frage zur Lage erlaubt.",
    short: "Spielleitung beantwortet 1 Lagefrage.",
    rule: "Frage darf keine Ortsnamen enthalten."
  },
  {
    name: "Orientierungsjoker",
    type: "Power-Up",
    desc: "10 Min. Navi-Nutzung erlaubt.",
    short: "Navigation 10 Min. frei trotz Fluch.",
    rule: "Gilt auch unter Karten-Verbot."
  },
  {
    name: "Blockrunde",
    type: "Fluch",
    desc: "Alle m√ºssen einmal um einen Block laufen.",
    short: "Einmal gemeinsam um ein H√§userblock.",
    rule: "Video muss Start und Ziel klar zeigen."
  },
  {
    name: "Drehsinn",
    type: "Fluch",
    desc: "10√ó schnell im Kreis drehen mit blick auf die Zehenspitzen.",
    short: "10 schnelle Drehungen pro Person.",
    rule: "Vor der Aufgabe, unter Aufsicht."
  },
  {
    name: "Kolibrimodus",
    type: "Fluch",
    desc: "3 Min. r√ºckw√§rts laufen.",
    short: "3 Minuten R√ºckw√§rtsgang aktiv.",
    rule: "Gilt f√ºr die gesamte Gruppe."
  },
  {
    name: "Stille Stunde",
    type: "Fluch",
    desc: "3 Min. kein Sprechen oder Gestikulieren.",
    short: "3 Minuten komplett stumm.",
    rule: "Verstoss f√ºhrt zu Neuanfang."
  },
  {
    name: "Klebezettel",
    type: "Fluch",
    desc: "Etwas muss auf dem Kopf balanciert werden.",
    short: "F√§llt der Gegenstand w√§hrend der Aufgabe, ist sie gescheitert.",
    rule: "Kein Festkleben oder Abst√ºtzen erlaubt."
  },
  {
    name: "Blindes Vertrauen",
    type: "Fluch",
    desc: "3 Personen mit verbundenen Augen (5 Min.).",
    short: "F√ºr 5 Minuten d√ºrfen 3 aus dem Team nichts sehen.",
    rule: "Muss von anderen gef√ºhrt werden."
  },
  {
    name: "Team-Schnecke",
    type: "Fluch",
    desc: "Alle mit einem Finger verbunden f√ºr 2 min.",
    short: "Zeigefingerkette",
    rule: "Verbindung darf nie rei√üen."
  },
  {
    name: "Hindernis-Start",
    type: "Fluch",
    desc: "Vorher 10 Hampelm√§nner.",
    short: "Bevor‚Äôs losgeht: 10 Hampelm√§nner.",
    rule: "Alle gleichzeitig, im Video ersichtlich."
  }
],

selten: [
  {
    name: "Zeitsplitter",
    type: "Power-Up",
    desc: "5 Minuten mehr Zeit.",
    short: "Verl√§ngert die Aufgabe.",
    rule: "Einmal pro Aufgabe einl√∂sbar."
  },
  {
    name: "Nebel des Krieges",
    type: "Power-Up",
    desc: "Aufgabe abbrechen und neu starten.",
    short: "Reset-Karte f√ºr schwierige Aufgaben.",
    rule: "Nur bei nicht begonnenen Aufgaben erlaubt."
  },
  {
    name: "Deal des Teufels",
    type: "Power-Up",
    desc: "W√ºrfeln ‚Äì Chance auf bessere Effekte.",
    short: "1: Bronze, 2-4: Silber, 5-6: Gold",
    rule: "Nutze eine Lootbox entsprechend der Augenzahl."
  },
  {
    name: "Routenreset",
    type: "Power-Up",
    desc: "Aufgabe abbrechen ohne Konsequenz.",
    short: "Aufgabe kann neu begonnen werden.",
    rule: "Nicht kombinierbar mit Schatzfund."
  },
  {
    name: "Sp√§herblick",
    type: "Power-Up",
    desc: "Hinweis zur Lage eines Schatzes.",
    short: "Erhalte eine Schatz-Koordinatenhilfe.",
    rule: "Spielleitung gibt Koordinaten des Schatzes an."
  },
  {
    name: "Stra√üensperre",
    type: "Fluch",
    desc: "1 Gebiet 15 Min. gesperrt.",
    short: "Blockiert ein fremdes Gebiet.",
    rule: "Nur in einem angrenzenden Gebiet anwendbar."
  },
  {
    name: "Schneckenmodus",
    type: "Fluch",
    desc: "5 Min. r√ºckw√§rts laufen.",
    short: "Bewegung wird erschwert.",
    rule: "Gilt f√ºr alle Teammitglieder gleichzeitig."
  },
  {
    name: "Blackout",
    type: "Fluch",
    desc: "10 Min. kein Kontakt zur Zentrale.",
    short: "Team darf keine Nachrichten senden/empfangen.",
    rule: "Startet mit dem Ziehen des Fluchs."
  },
  {
    name: "Konfusion",
    type: "Fluch",
    desc: "Nur Papierkarte f√ºr 15 Min.",
    short: "Digitale Hilfsmittel verboten.",
    rule: "Spielleitung pr√ºft Einhaltung."
  },
  {
    name: "Schweigezauber",
    type: "Fluch",
    desc: "5 Min. totale Funkstille.",
    short: "Kein Reden, Schreiben oder Zeigen erlaubt.",
    rule: "Abbruch f√ºhrt zur Aufgabe-Neuversuchspflicht."
  }
],

episch: [
  {
    name: "Wegweiser",
    type: "Power-Up",
    desc: "Aufgabe vorab einsehen.",
    short: "Spoiler-Vorschau.",
    rule: "30 Sekunden Einsicht in die Aufgabe."
  },
  {
    name: "Sprintschub",
    type: "Power-Up",
    desc: "10 Bonusminuten.",
    short: "Mehr Zeit f√ºr die laufende Aufgabe.",
    rule: "Nur bei laufender Aufgabe einsetzbar."
  },
  {
    name: "Barrikade",
    type: "Power-Up",
    desc: "1 Gebiet 30 Min. blockieren.",
    short: "Sperrt ein beliebiges Gebiet tempor√§r.",
    rule: "Nur in Stadtteilen erlaubt, die kein Team besitzt."
  },
  {
    name: "Zeitschleife",
    type: "Fluch",
    desc: "Letzte Aufgabe nochmal machen.",
    short: "Zweite Runde f√ºr dieselbe Challenge.",
    rule: "Gilt auch bei bereits bestandenem Versuch."
  },
  {
    name: "Ausr√ºstungsfluch",
    type: "Fluch",
    desc: "Handicap-Aufgabe (z.‚ÄØB. blind, einbeinig, ...).",
    short: "Erschwerte Ausf√ºhrung.",
    rule: "Spielleitung bestimmt das Handicap live."
  },
  {
    name: "Nebelzone",
    type: "Fluch",
    desc: "10 Min. keine Karten erlaubt.",
    short: "Navigation im Blindflug.",
    rule: "Weder digital noch analog erlaubt."
  }
],

legend√§r: [
  {
    name: "Schattenl√§ufer",
    type: "Power-Up",
    desc: "Gebiet klauen ohne Aufgabe.",
    short: "Heimlicher Eroberer.",
    rule: "Man muss sich in dem Gebiet befinden."
  },
  {
    name: "Blitz des Zeus",
    type: "Power-Up",
    desc: "Gebiet aus der Ferne erobern.",
    short: "Fern-Eroberung.",
    rule: "Nur 1√ó im Spiel verwendbar ‚Äì Team muss nicht vor Ort sein."
  },
  {
    name: "Blizzard",
    type: "Fluch",
    desc: "Alle anderen bleiben 15 Min. an einem Ort.",
    short: "Gefriert alle Gegner.",
    rule: "Countdown beginnt sofort, Bewegtbilder sind verboten."
  },
  {
    name: "Sonnenwind",
    type: "Fluch",
    desc: "20 Min. kein Google Maps.",
    short: "Digitaler Navigationsausfall.",
    rule: "Digitale Navigation gesperrt, nur Papierkarten erlaubt."
  }
],
 mystisch: [
  {
    name: "G√∂ttliche Gunst",
    type: "Power-Up",
    desc: "+1 Punkt sofort.",
    short: "Himmlischer Segen.",
    rule: "Einmalig einsetzbar ‚Äì sofort +1 Punkt f√ºr das eigene Team."
  },
  {
    name: "Fluch der Tiefe",
    type: "Fluch",
    desc: "-1 Punkt f√ºr Gegner.",
    short: "Dunkle Macht.",
    rule: "Einmalig einsetzbar ‚Äì w√§hlt ein anderes Team, das 1 Punkt verliert."
  }
]

};

// Wahrscheinlichkeiten
const lootChances = {
  bronze: [70, 22, 6, 2, 0],
  silber: [30, 40, 22, 6, 2],
  gold: [2, 25, 35, 22, 6]
};

function selectLootbox(tier) {
  const confirmOpen = confirm(`M√∂chtest du eine ${tier}-Lootbox wirklich √∂ffnen?`);
  if (!confirmOpen) return;

  // Truhe zentrieren und animieren
  const lidColors = {
  bronze: "#8B5A2B",    // dunkelbraun
  silber: "#aaa",       // silbergrau
  gold: "#D4AF37"       // gold
};

const baseColors = {
  bronze: "#CD853F",    // heller braunton
  silber: "#ccc",       // helleres silber
  gold: "#FFD700"       // gelber goldton
};

const content = document.getElementById("lootboxContent");
content.innerHTML = `
  <div id="boxWrapper" class="shake">
    <div class="chest ${tier}">
      <div class="lid"></div>
      <div class="base"></div>
    </div>
  </div>
  <div id="result" style="margin-top: 20px;"></div>
`;

  // Farben je nach Truhentyp setzen
const lid = document.querySelector(".lid");
const base = document.querySelector(".base");

if (tier === "bronze") {
  lid.style.background = "saddlebrown";
  lid.style.borderColor = "#5a2d0c";
  base.style.background = "peru";
  base.style.borderColor = "#5a2d0c";
} else if (tier === "silber") {
  lid.style.background = "#bbb";
  lid.style.borderColor = "#999";
  base.style.background = "#ddd";
  base.style.borderColor = "#999";
} else if (tier === "gold") {
  lid.style.background = "#ffd700";
  lid.style.borderColor = "#daa520";
  base.style.background = "#fff8dc";
  base.style.borderColor = "#daa520";
}


  // Nach 5 Sekunden: Effekt ziehen
setTimeout(() => {
  const box = document.getElementById("boxWrapper");
  box.classList.remove("shake");
  box.querySelector(".chest").classList.add("open");

  setTimeout(() => {
    const rarity = drawRarity(lootChances[tier]);
    const list = effects[rarity];
    const drawn = list[Math.floor(Math.random() * list.length)];


const borderColor = {
  gew√∂hnlich: "green",
  selten: "blue",
  episch: "purple",
  legend√§r: "gold",
  mystisch: "turquoise"
}[rarity];

const bgColor = {
  gew√∂hnlich: "rgba(46, 204, 113, 0.15)",     // sanftes Gr√ºn
  selten: "rgba(0, 119, 255, 0.15)",          // sanftes Blau
  episch: "rgba(128, 0, 128, 0.15)",          // Violett
  legend√§r: "rgba(255, 215, 0, 0.15)",        // Goldgelb
  mystisch: "rgba(64, 224, 208, 0.15)"        // T√ºrkis
}[rarity];

const result = `
  <div style="
    border: 4px solid ${borderColor};
    border-radius: 12px;
    padding: 10px;
    position: relative;
    background: ${bgColor};
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    margin-top: 10px;
    font-family: sans-serif;
    box-shadow: 0 0 10px ${borderColor};
    transition: background 0.5s ease;
  ">
    <div style="font-size: 12px; font-weight: bold; color: ${borderColor};">
      ${drawn.type} ‚Äì ${rarity.toUpperCase()}
    </div>
    <div style="font-size: 18px; font-weight: bold; margin-top: 5px;">
      ${drawn.name}
    </div>
    <div style="font-size: 14px; margin-top: 5px;">
      ${drawn.desc}
    </div>
    <div style="font-size: 13px; margin-top: 8px; font-style: italic; color: #333;">
      üí¨ ${drawn.short}
    </div>
    <div style="font-size: 12px; margin-top: 5px; color: #555;">
      üìú <strong>Miniregel:</strong> ${drawn.rule}
    </div>
    <div class="sparkle-container"></div>
  </div>
`;

document.getElementById("result").innerHTML = result;
generateSparkles();


  }, 700); // kurze Pause nach Deckelanimation
}, 5000); // nach dem Zittern

}

function drawRarity(chances) {
  const roll = Math.random() * 100;
  let cumulative = 0;
  const rarities = ["gew√∂hnlich", "selten", "episch", "legend√§r", "mystisch"];
  for (let i = 0; i < chances.length; i++) {
    cumulative += chances[i];
    if (roll < cumulative) return rarities[i];
  }
  return "gew√∂hnlich";
}

function generateSparkles() {
  const container = document.querySelector(".sparkle-container");
  for (let i = 0; i < 64; i++) {
    const dot = document.createElement("div");
    dot.style.position = "absolute";
    dot.style.width = "4px";
    dot.style.height = "4px";
    dot.style.borderRadius = "50%";
    dot.style.background = "gold";
    dot.style.animation = `twinkle 1s ${Math.random()}s infinite alternate`;
    dot.style.left = `${Math.random() * 100}%`;
    dot.style.top = `${Math.random() * 100}%`;
    container.appendChild(dot);
  }
  setTimeout(() => {
  container.innerHTML = "";
}, 10000);

}

    function updateTreasureVisibility() {
  const zoom = map.getZoom();

  Object.values(treasureCircles).forEach(obj => {
    if (!obj.iconMarker) return;

    // Faustregel: ab Zoomstufe 17 sind Kreise > Bildschirm
    if (zoom >= 14) {
      map.removeLayer(obj.iconMarker);
    } else {
      if (!map.hasLayer(obj.iconMarker)) {
        obj.iconMarker.addTo(map);
      }
    }
  });
}
window.resetGameCode = resetGameCode;
window.resetAllColors = resetAllColors;
window.selectLootbox = selectLootbox;
window.openLootboxPopup = openLootboxPopup;
window.closeLootboxPopup = closeLootboxPopup;


</script>

<style>
@keyframes twinkle {
  from { opacity: 0.2; transform: scale(0.8); }
  to { opacity: 1; transform: scale(1.2); }
}

  .lootbox-card {
  width: 150px;
  height: 150px;
  background: white;
  border: 4px solid gold;
  border-radius: 20px;
  text-align: center;
  padding: 10px;
  cursor: pointer;
  box-shadow: 0 0 8px rgba(0,0,0,0.3);
  display: flex;
  flex-direction: column;
  justify-content: center;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.lootbox-card:hover {
  transform: scale(1.05);
  box-shadow: 0 0 12px rgba(255, 215, 0, 0.7);
}
.loot-icon {
  font-size: 60px;
  margin-bottom: 8px;
}
.loot-price {
  font-size: 14px;
  color: #888;
  margin-bottom: 5px;
}
.loot-label {
  font-weight: bold;
  font-size: 16px;
}

/* Farbliche R√§nder nach Typ */
.lootbox-card.bronze {
  border-color: #cd7f32;
}
.lootbox-card.silber {
  border-color: #aaa;
}
.lootbox-card.gold {
  border-color: #ffd700;
}

</style>



  
<div id="resetButton" class="adminOnly" style="
  position: fixed;
  bottom: 20px;
  left: 20px;
  background: white;
  padding: 10px;
  border-radius: 5px;
  font-family: sans-serif;
  box-shadow: 0 0 5px rgba(0,0,0,0.3);
  z-index: 1000;">
  <button onclick="resetAllColors()">üîÅ Karte zur√ºcksetzen</button>
  <button onclick="resetGameCode()" style="margin-top: 10px;">üÜï Neues Spiel starten</button>

</div>

<div id="lootboxPopup" style="
  display: none;
  position: fixed;
  top: 10%;
  left: 50%;
  transform: translateX(-50%);
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 0 15px rgba(0,0,0,0.3);
  z-index: 2000;
  font-family: sans-serif;
  width: 320px;
  text-align: center;
">
  <div id="lootboxContent"></div>
  <button onclick="closeLootboxPopup()">‚úñÔ∏è Schlie√üen</button>
</div>

  
</body>
</html>
